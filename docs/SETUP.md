# Winmix Setup & Migration Guide

This guide walks you through installing project dependencies, configuring environment variables, running the Winmix application locally, and understanding the recent migration from a Next.js-style setup to the current Vite-based stack. The instructions emphasise Windows support, but notes for macOS and Linux are included where relevant.

---

## 1. Prerequisites

### Required software
- **Node.js LTS 20.17.1** – matches the version pinned in `.nvmrc`.  
  - Windows (PowerShell): `winget install OpenJS.NodeLTS`.  
  - macOS/Linux: install via [nvm](https://github.com/nvm-sh/nvm) then run `nvm install 20.17.1`.
- **pnpm (v8+)** – package manager used across the repository.  
  - Once Node is installed, enable Corepack: `corepack enable` (PowerShell or terminal).  
  - Confirm installation with `pnpm --version`.
- **Git** – source control client.  
  - Windows: `winget install Git.Git`
  - macOS: `brew install git`

### Optional, but recommended
- **Docker Desktop** – required if you prefer running Supabase locally in containers.  
  - Windows: `winget install Docker.DockerDesktop` (requires WSL2).  
  - macOS: download from [docker.com](https://www.docker.com/products/docker-desktop/).
- **Supabase CLI** – used for applying migrations and interacting with Supabase projects.  
  - Install globally: `npm install -g supabase` or `pnpm dlx supabase --help` to run ad-hoc commands.  
  - After installation, run `supabase --version` to verify.

> **Tip:** On Windows, PowerShell (v7+) and Git Bash both work. Scripts ending with `.sh` expect a POSIX shell; use the provided `.bat` alternatives or run them via Git Bash/WSL.

---

## 2. Repository setup

1. **Clone the repository**
   ```powershell
   git clone https://github.com/<your-org>/winmix.git
   cd winmix
   ```
2. **Install dependencies**
   ```powershell
   pnpm install
   ```
3. **Workspace awareness**  
   The project is managed as a pnpm workspace (see `pnpm-workspace.yaml`). Even though the app currently lives at the repository root, the workspace keeps tooling consistent across packages if more are added later.
4. **Path aliases**  
   TypeScript is configured with the `@/` alias (see `tsconfig.json`) so that any file under `src/` can be imported using `@/some/module` instead of relative paths. Ensure your IDE understands this alias for features like auto-complete and navigation.

---

## 3. Environment configuration

1. **Create your local environment file**
   ```powershell
   Copy-Item .env.example .env
   ```
   *(macOS/Linux: `cp .env.example .env`)*
2. **Populate the required keys**  
   The `.env.example` file contains placeholders:
   ```dotenv
   VITE_SUPABASE_URL=https://your-project-ref.supabase.co
   VITE_SUPABASE_ANON_KEY=your_anon_key_here
   VITE_SUPABASE_PROJECT_ID=your_project_ref_here

   NEXT_PUBLIC_SUPABASE_URL=${VITE_SUPABASE_URL}
   NEXT_PUBLIC_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
   ```
   - `VITE_SUPABASE_URL` – Supabase project REST URL. Required.
   - `VITE_SUPABASE_ANON_KEY` – public anon key used by the client. Required.
   - `VITE_SUPABASE_PROJECT_ID` – optional project reference, used when interacting with the Supabase CLI.
   - `NEXT_PUBLIC_SUPABASE_*` – kept for backwards compatibility during the migration. If these are missing, the client falls back to the `VITE_*` values.
3. **Additional environment variables**  
   Add any other integration keys you need. Do **not** commit the `.env` file.

---

## 4. Supabase client configuration

The Supabase client lives at `src/integrations/supabase/client.ts` and centralises all Supabase usage in the front-end. It prefers the new `VITE_*` environment variables but still supports the legacy `NEXT_PUBLIC_*` keys during the migration period:

```ts
const NEXT_PUBLIC_SUPABASE_URL = import.meta.env.NEXT_PUBLIC_SUPABASE_URL || import.meta.env.VITE_SUPABASE_URL;
const NEXT_PUBLIC_SUPABASE_ANON_KEY =
  import.meta.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ||
  import.meta.env.VITE_SUPABASE_ANON_KEY ||
  import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY;
```

If either value is missing, the client throws an error unless the app is in `test` mode. After updating environment variables, restart `pnpm dev` so Vite picks up the changes.

To use Supabase elsewhere in the app, always import the shared client:
```ts
import { supabase } from '@/integrations/supabase/client';
```

---

## 5. Database and migrations

Supabase resources (SQL migrations, edge functions, policies, etc.) live under `src/supabase/`:
- `src/supabase/migrations` – SQL files generated by the Supabase CLI.
- `src/supabase/functions` – edge function definitions.
- `src/supabase/policies` – RLS policies and helpers.

To apply migrations locally or against a linked project:

1. **Install and authenticate the Supabase CLI**
   ```powershell
   supabase login
   supabase link --project-ref <your-project-ref>
   ```
2. **Apply the latest migrations**
   ```powershell
   cd src/supabase
   supabase db push
   ```
   This command runs all SQL migrations and keeps your schema in sync with the linked project.
3. **(Optional) Local Supabase stack**  
   If you want to run Supabase locally:
   ```powershell
   supabase start
   supabase db reset      # resets and reapplies migrations
   ```

If the project does not yet ship database migrations, coordinate with the backend team before running the CLI. The directory structure above is ready for future migration files.

---

## 6. Common scripts & running the app

All scripts are executed with `pnpm` from the repository root.

| Command | Description |
|---------|-------------|
| `pnpm dev` | Starts the Vite development server with hot module reloading. |
| `pnpm build` | Produces a production build in `dist/`. |
| `pnpm preview` | Serves the production build locally for verification. |
| `pnpm lint` | Runs ESLint across the project (`.js`, `.jsx`, `.ts`, `.tsx`). |
| `pnpm typecheck` | Executes TypeScript in `--noEmit` mode to validate types. |
| `pnpm test` | Runs the Vitest suite (headless). Add `--watch` if you want interactive mode. |

> **Heads up (Windows):** When running scripts that rely on Bash (such as the circular dependency utilities), prefer Git Bash or WSL. For purely Node-based scripts, PowerShell works fine.

---

## 7. Windows-specific notes

- **Shell choice:** Use PowerShell for most commands. For Bash scripts (`*.sh`), run them via Git Bash or WSL. A Windows-friendly alternative exists at `src/fix-circular-dependency.bat`.
- **Execution policy:** If PowerShell blocks script execution, run `Set-ExecutionPolicy -Scope CurrentUser RemoteSigned` once.
- **Line endings:** Keep `core.autocrlf` disabled to avoid double conversions: `git config --global core.autocrlf false`. The repository ships with `.editorconfig` defaults for LF.
- **Environment files:** Save `.env` files in UTF-8 without BOM. PowerShell’s `Out-File` adds BOM by default; prefer editors like VS Code or use `Set-Content`.
- **File watchers:** On Windows, ensure `pnpm` commands run from a path without spaces to prevent watcher issues.

---

## 8. Troubleshooting

| Issue | How to fix |
|-------|------------|
| **Missing Supabase env vars** | Confirm `.env` contains the Supabase keys and restart the dev server. The app throws a descriptive error if required keys are absent. |
| **`@/` alias not resolving** | Ensure your IDE uses the TypeScript config at the project root. Running `pnpm typecheck` will surface misconfigured paths. |
| **Circular dependency warnings** | Run `pnpm dlx madge --circular src` to list offenders. Use `src/fix-circular-dependency.sh` (Git Bash) or `src/fix-circular-dependency.bat` (PowerShell) for automated cleanup steps. |
| **Stale dependencies / build cache** | Remove caches and reinstall: <br>`rd /s /q node_modules` (PowerShell) or `rm -rf node_modules` <br>`pnpm store prune` <br>`pnpm install --force` <br>`pnpm rebuild` |
| **Vite stuck on old env values** | Stop the dev server, delete `node_modules/.vite`, then restart with `pnpm dev`. |
| **Supabase CLI authentication issues** | Run `supabase logout` and `supabase login` again. Ensure you are using the same project reference as in `VITE_SUPABASE_PROJECT_ID`. |

---

## 9. Migration guide (Next.js → Vite)

Use this checklist if you are upgrading legacy codebases:

1. **Environment variable renaming**  
   - Rename any `NEXT_PUBLIC_SUPABASE_*` variables to `VITE_SUPABASE_*`.  
   - Leave the legacy keys temporarily if third-party tooling still expects them; the client falls back to the new names automatically.
2. **Rename non-JSX modules**  
   - Files that do not render JSX should use the `.ts` extension. Update imports accordingly to benefit from Vite’s faster compilation.
3. **Consolidate the Supabase client**  
   - Remove older `client.tsx` instances and import the shared client from `src/integrations/supabase/client.ts`.  
   - Verify there are no bare `from 'supabase'` imports.
4. **TypeScript & workspace cleanup**  
   - Confirm `tsconfig.json` has `baseUrl` set to `.` and the `@/*` path alias.  
   - Tidy `pnpm-workspace.yaml` to only track active packages; remove stale references from past Next.js apps.
5. **Re-run tooling**  
   - Execute `pnpm lint`, `pnpm typecheck`, and `pnpm test` to ensure the migration is stable.  
   - Rebuild with `pnpm build` and spot-check `pnpm preview` locally.

---

## Next steps

You are ready to run the Winmix application locally:
```powershell
pnpm dev
```
Open the URL printed by Vite (usually `http://localhost:5173`) in your browser. If you hit issues that are not covered here, document the fix in `docs/SETUP.md` so the whole team benefits.
