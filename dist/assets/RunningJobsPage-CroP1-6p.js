import{al as w,r as i,j as e,aj as T,C as b,a as v,b as y,z as S,B as z,c as I,aJ as B,aO as F,x as o,aP as P,bp as $,R as _}from"./index-GAVc2OtO.js";import{A as q}from"./AdminLayout-BhVK5JeJ.js";import{C as D}from"./ConfirmDialog-D2kmOE-C.js";import{u as E}from"./useJobs-BaphaOCq.js";import"./sheet-DgW-QWTQ.js";import"./index-DD5cTla9.js";import"./useQuery-CV8yfldm.js";import"./workflow-PVWcfWK5.js";import"./cpu-C0sgczmA.js";import"./database-CX9CnqQc.js";import"./useMutation-C-Rbfrtn.js";import"./useAuditLog-DaCpHk4g.js";const O=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],V=w("square",O);const H=[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]],Y=w("timer",H),G=t=>t.last_log?.status==="running"?"Running":t.enabled?"Scheduled":"Stopped",K=t=>t.last_log?.status==="running"?"default":t.enabled?"secondary":"destructive",Q=t=>{const n=t.stats.total_runs;return n?Math.round(t.stats.success_runs/n*100):0},oe=()=>{const{jobs:t,isLoading:n,isFetching:l,refetch:C,startJob:J,stopJob:k,isStarting:m,isStopping:c}=E({refetchInterval:3e4}),[a,d]=i.useState(null),[x,p]=i.useState(null),[u,h]=i.useState(null),g=i.useMemo(()=>t.filter(s=>s.last_log?.status==="running").length,[t]),L=async s=>{p(s.job_name);try{await J(s.job_name)}catch(r){console.error("Failed to start job",r)}finally{p(null)}},R=async()=>{if(a){h(a.id);try{await k(a.id)}catch(s){console.error("Failed to stop job",s)}finally{h(null),d(null)}}},A=i.useMemo(()=>n?Array.from({length:4}).map((s,r)=>e.jsx(T,{className:"h-48 w-full"},`jobs-skeleton-${r}`)):t.length===0?e.jsx(b,{className:"bg-muted/30",children:e.jsxs(v,{children:[e.jsx(y,{children:"No running jobs"}),e.jsx(S,{children:"Scheduled jobs will appear here once configured."})]})}):t.map(s=>{const r=Q(s),M=G(s),f=r,j=m&&x===s.job_name,N=c&&u===s.id;return e.jsxs(b,{className:"border-border/60 bg-card/60 backdrop-blur",children:[e.jsxs(v,{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx(y,{className:"text-lg font-semibold",children:s.job_name}),e.jsx(S,{children:s.job_type})]}),e.jsx(z,{variant:K(s),children:M})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(Y,{className:"h-3.5 w-3.5"}),e.jsxs("span",{children:["Next run: ",s.next_run_at?new Date(s.next_run_at).toLocaleString():"Manual"]})]})]}),e.jsxs(I,{className:"flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:"Success rate"}),e.jsxs("div",{className:"mt-2 flex items-center gap-3",children:[e.jsx(B,{value:f,className:"h-2 flex-1"}),e.jsxs("span",{className:"text-sm font-medium text-foreground",children:[f,"%"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs text-muted-foreground",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:"Total runs"}),e.jsx("p",{children:s.stats.total_runs})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:"Average duration"}),e.jsx("p",{children:s.average_duration_ms?`${Math.round(s.average_duration_ms/1e3)}s`:"–"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:"Enabled"}),e.jsx("p",{children:s.enabled?"Yes":"No"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:"Last status"}),e.jsx("p",{children:s.last_log?.status??"–"})]})]})]}),e.jsxs(F,{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(o,{variant:"outline",size:"default",className:"h-11 gap-2",onClick:()=>L(s),disabled:j||l,children:[e.jsx(P,{className:"h-4 w-4"}),j?"Starting…":"Start"]}),e.jsxs(o,{variant:"destructive",size:"default",className:"h-11 gap-2",onClick:()=>d(s),disabled:N||!s.enabled,children:[e.jsx(V,{className:"h-4 w-4"}),N?"Stopping…":"Stop"]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(o,{asChild:!0,variant:"ghost",size:"default",className:"h-11 gap-2",children:e.jsxs($,{to:`/jobs?jobId=${s.id}`,children:[e.jsx(_,{className:"h-4 w-4"}),"Logs"]})})})]})]},s.id)}),[n,t,m,x,c,u,l]);return e.jsxs(q,{title:"Running Jobs",description:"Monitor and control live automation pipelines.",breadcrumbs:[{label:"Admin",href:"/admin"},{label:"Jobs"}],actions:e.jsxs(o,{variant:"outline",size:"lg",className:"gap-2",onClick:()=>void C(),disabled:l,children:[e.jsx(_,{className:l?"h-4 w-4 animate-spin":"h-4 w-4"}),"Refresh"]}),children:[e.jsxs("section",{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-wrap items-center justify-between gap-3",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:[g," job",g===1?" is":"s are"," currently running."]})}),e.jsx("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-2 xl:grid-cols-3",children:A})]}),e.jsx(D,{open:!!a,onOpenChange:s=>{s||d(null)},title:"Stop job",description:a?e.jsxs("span",{children:["Are you sure you want to stop ",e.jsx("span",{className:"font-semibold",children:a.job_name}),"? This may interrupt active processing."]}):"",confirmLabel:"Stop job",destructive:!0,isConfirmLoading:c&&u===a?.id,onConfirm:()=>{R()}})]})};export{oe as default};
