import{al as q,am as D,r as x,j as t,x as h,ba as I,aP as P,bi as L,ab as z,k as A,an as m,w as p}from"./index-oF1ARjuv.js";import{u as J}from"./useQuery-CWzqJKQX.js";import{u as N}from"./useMutation-DOyzXJwO.js";import{S as K}from"./switch-D15vbeAy.js";import{W as b}from"./MetricCard-Blih6JUP.js";import{W as Q,a as W}from"./Page-C3pqLVgn.js";import{u as R}from"./usePersistentState-3WMPisrB.js";const H=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 8 14",key:"tmc9b4"}]],U=q("clock-8",H),G={data_import:"Adat import",prediction:"Modellezés",aggregation:"Aggregáció",maintenance:"Karbantartás",monitoring:"Monitoring"},B={running:"bg-emerald-500/10 text-emerald-200",success:"bg-sky-500/10 text-sky-200",queued:"bg-amber-500/10 text-amber-200",error:"bg-rose-500/10 text-rose-200",disabled:"bg-white/10 text-white/60",due:"bg-amber-500/10 text-amber-200"},u={running:"Fut",success:"Sikeres",queued:"Sorban",error:"Hiba",disabled:"Letiltva",due:"Esedékes"},k={success:A,running:z,error:L},X={success:"text-emerald-300",running:"text-sky-300",error:"text-rose-300"},y=a=>G[a]??a,_=a=>{if(!a||a<=0)return"—";const r=Math.floor(a/1e3),g=Math.floor(r/60),c=r%60;return`${g}p ${c.toString().padStart(2,"0")}mp`},S=a=>{if(!a)return"—";const r=new Date(a);return Number.isNaN(r.getTime())?"—":new Intl.DateTimeFormat("hu-HU",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(r)},Z=a=>{const r=new Date(a);return Number.isNaN(r.getTime())?a:new Intl.DateTimeFormat("hu-HU",{hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(r)},O=async()=>{const{data:a,error:r}=await p.functions.invoke("jobs-list",{method:"GET"});if(r)throw new Error(r.message??"Nem sikerült betölteni a feladatokat");return a?.jobs??[]},ie=()=>{const a=D(),[r,g]=R("winmixpro-job-filter","all"),c=J({queryKey:["winmixpro","jobs"],queryFn:O,refetchInterval:3e4}),f=N({mutationFn:async({jobId:e,enabled:s})=>{const{data:i,error:l}=await p.functions.invoke("jobs-toggle",{body:{jobId:e,enabled:s}});if(l)throw new Error(l.message??"Nem sikerült frissíteni a job állapotát");return i?.job},onSuccess:(e,{enabled:s})=>{m.success(`Feladat ${s?"engedélyezve":"letiltva"}`),a.invalidateQueries({queryKey:["winmixpro","jobs"]})},onError:e=>{const s=e instanceof Error?e.message:"Ismeretlen hiba";m.error(s)}}),w=N({mutationFn:async e=>{const{data:s,error:i}=await p.functions.invoke("jobs-trigger",{body:{jobId:e}});if(i)throw new Error(i.message??"Nem sikerült futtatni a feladatot");return s?.result},onSuccess:e=>{e?m.success(`Feladat futtatva – ${e.recordsProcessed??0} rekord feldolgozva`):m.success("Feladat futtatás elindítva"),a.invalidateQueries({queryKey:["winmixpro","jobs"]})},onError:e=>{const s=e instanceof Error?e.message:"Ismeretlen hiba";m.error(s)}}),n=c.data??[],C=x.useMemo(()=>{const e=Array.from(new Set(n.map(s=>s.job_type)));return[{value:"all",label:"Összes"},...e.map(s=>({value:s,label:y(s)}))]},[n]),v=x.useMemo(()=>r==="all"?n:n.filter(e=>e.job_type===r),[n,r]),o=x.useMemo(()=>{const e=n.length,s=n.filter(d=>d.enabled).length,i=n.filter(d=>d.last_log?.status==="running").length,l=n.map(d=>d.average_duration_ms).filter(d=>typeof d=="number"&&d>0),E=l.length>0?l.reduce((d,T)=>d+T,0)/l.length:null,F=e>0?Math.round(s/e*100):0;return{total:e,enabled:s,running:i,automationScore:F,average:E}},[n]),j=x.useMemo(()=>n.flatMap(s=>(s.recent_logs??[]).map(i=>({...i,jobName:s.job_name}))).sort((s,i)=>new Date(i.started_at).getTime()-new Date(s.started_at).getTime()).slice(0,8),[n]),M=e=>e.enabled?e.last_log?.status==="running"?{key:"running",label:u.running}:e.last_log?.status==="success"?{key:"success",label:u.success}:e.last_log?.status==="error"?{key:"error",label:u.error}:e.is_due?{key:"due",label:u.due}:{key:"queued",label:u.queued}:{key:"disabled",label:u.disabled},$=e=>!e.stats||e.stats.total_runs===0?0:Math.round(e.stats.success_runs/e.stats.total_runs*100);return t.jsx(Q,{title:"Automatizált folyamatok",description:"Scheduler, job életciklus és SLA státuszok – valós Supabase adatokkal.",actions:t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs(h,{size:"sm",variant:"secondary",className:"bg-white/5 text-white hover:bg-white/10",onClick:()=>void c.refetch(),disabled:c.isFetching,children:[t.jsx(z,{className:`mr-2 h-4 w-4 ${c.isFetching?"animate-spin":""}`}),"Frissítés"]})}),children:c.isLoading?t.jsx(W,{}):c.isError?t.jsxs("div",{className:"rounded-3xl border border-rose-500/30 bg-rose-500/10 p-6 text-rose-100",children:[t.jsx("p",{className:"font-semibold",children:"Nem sikerült betölteni az ütemezett feladatokat."}),t.jsx("p",{className:"mt-2 text-sm opacity-80",children:c.error?.message??"Ismeretlen hiba"}),t.jsx(h,{size:"sm",className:"mt-4 bg-white/10 text-white hover:bg-white/20",onClick:()=>void c.refetch(),children:"Újra"})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[t.jsx(b,{label:"Aktív jobok",value:`${o.enabled}/${o.total}`,hint:"Engedélyezett / összes",trend:o.running>0?`${o.running} fut`:"—",intent:"positive",icon:U}),t.jsx(b,{label:"Automatizációs pont",value:`${o.automationScore}%`,hint:"Engedélyezett arány",trend:o.automationScore>=80?"Jó lefedettség":"Növelhető",intent:o.automationScore>=80?"positive":o.automationScore>=60?"neutral":"warning",icon:I}),t.jsx(b,{label:"Átlagos futási idő",value:_(o.average),hint:"Utolsó futások átlaga",trend:o.average?`${Math.floor((o.average??0)/1e3)} mp`:"—",intent:"neutral"})]}),t.jsx("div",{className:"rounded-3xl border border-white/15 bg-white/5 p-4 backdrop-blur",children:t.jsx("div",{className:"flex flex-wrap gap-2",children:C.map(e=>t.jsx(h,{size:"sm",variant:r===e.value?"default":"secondary",className:r===e.value?"bg-emerald-500 text-white hover:bg-emerald-600":"bg-white/5 text-white/70 hover:bg-white/10",onClick:()=>g(e.value),children:e.label},e.value))})}),t.jsxs("div",{className:"grid gap-6 lg:grid-cols-[2fr,1fr]",children:[t.jsx("div",{className:"rounded-3xl border border-white/10 bg-black/50 p-4",children:v.length===0?t.jsx("div",{className:"rounded-2xl border border-dashed border-white/20 p-6 text-center text-sm text-white/60",children:"Nincs megjeleníthető job ebben a kategóriában."}):t.jsx("div",{className:"space-y-4",children:v.map(e=>{const s=M(e),i=$(e),l=typeof e.config?.description=="string"?e.config.description:null;return t.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/5/40 p-4 transition hover:border-white/30",children:[t.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-lg font-semibold text-white",children:e.job_name}),t.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-white/40",children:y(e.job_type)}),l?t.jsx("p",{className:"mt-1 text-xs text-white/60",children:l}):null]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[t.jsx("span",{className:`rounded-full px-3 py-1 text-xs font-semibold ${B[s.key]}`,children:s.label}),t.jsxs("label",{className:"flex items-center gap-2 text-xs text-white/60",children:[t.jsx(K,{checked:e.enabled,onCheckedChange:()=>f.mutate({jobId:e.id,enabled:!e.enabled}),disabled:f.isPending}),"Engedélyezett"]}),t.jsxs(h,{size:"sm",variant:"ghost",className:"text-white/70 hover:bg-white/10",onClick:()=>w.mutate(e.id),disabled:w.isPending,children:[t.jsx(P,{className:"mr-1 h-3.5 w-3.5"})," Futatás"]})]})]}),t.jsxs("div",{className:"mt-4 grid gap-4 md:grid-cols-4",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase text-white/50",children:"Ütemezés"}),t.jsx("p",{className:"text-sm text-white",children:e.cron_schedule})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase text-white/50",children:"Legutóbbi futás"}),t.jsx("p",{className:"text-sm text-white",children:S(e.last_run_at)})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase text-white/50",children:"Következő futás"}),t.jsx("p",{className:"text-sm text-white",children:S(e.next_run_at)})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase text-white/50",children:"Sikeresség"}),t.jsx("div",{className:"mt-1 h-2 rounded-full bg-white/10",children:t.jsx("div",{className:"h-full rounded-full bg-emerald-400",style:{width:`${i}%`}})}),t.jsxs("p",{className:"text-xs text-white/60",children:[i,"%"]})]})]})]},e.id)})})}),t.jsxs("div",{className:"rounded-3xl border border-white/10 bg-gradient-to-b from-white/10 to-black/60 p-4",children:[t.jsx("p",{className:"text-sm font-semibold uppercase tracking-[0.4em] text-white/60",children:"Legutóbbi események"}),j.length===0?t.jsx("p",{className:"mt-4 text-sm text-white/60",children:"Még nincs futási előzmény."}):t.jsx("ol",{className:"mt-4 space-y-6 border-l border-white/20 pl-6",children:j.map(e=>{const s=e.status in k?e.status:"running",i=k[s],l=X[s]??"text-white";return t.jsxs("li",{className:"relative",children:[t.jsx("span",{className:"absolute -left-3 top-0 flex h-6 w-6 items-center justify-center rounded-full bg-black",children:t.jsx(i,{className:`h-4 w-4 ${l}`})}),t.jsxs("div",{className:"rounded-2xl bg-black/40 p-3",children:[t.jsx("p",{className:"text-xs uppercase tracking-[0.35em] text-white/40",children:Z(e.started_at)}),t.jsx("p",{className:"text-sm font-semibold text-white",children:e.jobName}),t.jsxs("p",{className:"text-xs text-white/60",children:[u[s]??e.status,e.duration_ms?` • ${_(e.duration_ms)}`:"",typeof e.records_processed=="number"?` • ${e.records_processed} rekord`:""]})]})]},`${e.id}-${e.started_at}`)})})]})]})]})})};export{ie as default};
