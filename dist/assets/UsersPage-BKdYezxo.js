import{al as z,am as X,bq as Y,r as o,an as d,j as e,as as Q,aA as Z,aB as ee,aC as b,aD as S,aE as se,aF as u,aM as ae,at as H,au as K,av as O,aw as V,az as x,x as h,w as C}from"./index-GAVc2OtO.js";import{u as te}from"./useQuery-CV8yfldm.js";import{u as I}from"./useMutation-C-Rbfrtn.js";import{A as ne}from"./AdminLayout-BhVK5JeJ.js";import{C as le}from"./ConfirmDialog-D2kmOE-C.js";import{D as re,b as ie,c as oe,d as ce,e as de,f as me}from"./dialog-I4-_6RT2.js";import{u as ue}from"./useAuditLog-DaCpHk4g.js";import{S as xe}from"./search-0AOMyqDJ.js";import{T as he}from"./trash-2-Dnjp8NsW.js";import"./sheet-DgW-QWTQ.js";import"./index-DD5cTla9.js";import"./workflow-PVWcfWK5.js";import"./cpu-C0sgczmA.js";import"./database-CX9CnqQc.js";const fe=[["path",{d:"M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h8",key:"12jkf8"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}],["path",{d:"M19 16v6",key:"tddt3s"}],["path",{d:"M16 19h6",key:"xwg31i"}]],pe=z("mail-plus",fe);const je=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],ye=z("user-plus",je),M=10,B="analyst",ge=t=>t.replace(/[%_]/g,n=>`\\${n}`),ve=async({page:t,search:n})=>{const l=t*M,c=l+M-1;let f=C.from("user_profiles").select("id, email, role, created_at, full_name",{count:"exact"}).order("created_at",{ascending:!1}).range(l,c);n&&(f=f.ilike("email",`%${ge(n)}%`));const{data:v,error:i,count:p}=await f;if(i)throw i;return{users:(v??[]).map(r=>({id:r.id,email:r.email,role:r.role,created_at:r.created_at,full_name:r.full_name??null})),total:p??0}},Ne=async({email:t,role:n})=>{const l=typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).slice(2,10)}`,{error:c}=await C.from("admin_invites").upsert({email:t,role:n,token:l,status:"pending"},{onConflict:"email"});if(c)throw c},we=async(t,n)=>{const{error:l}=await C.from("user_profiles").update({role:n}).eq("id",t);if(l)throw l},be=async t=>{const{error:n}=await C.from("user_profiles").delete().eq("id",t);if(n)throw n},Le=()=>{const t=X(),{profile:n}=Y(),{log:l}=ue(),[c,f]=o.useState(""),v=o.useDeferredValue(c.trim()),[i,p]=o.useState(0),[U,r]=o.useState(!1),[_,R]=o.useState(""),[T,A]=o.useState(B),[j,D]=o.useState(null),N=te({queryKey:["admin","users",{page:i,search:v}],queryFn:()=>ve({page:i,search:v}),keepPreviousData:!0}),w=I({mutationFn:Ne,onSuccess:async(s,a)=>{d.success(`Invite sent to ${a.email}`),await l("user_created",{email:a.email,role:a.role}),R(""),A(B),r(!1)},onError:s=>{d.error(`Failed to create invite: ${s.message}`)}}),q=I({mutationFn:async({userId:s,role:a})=>we(s,a),onMutate:async({userId:s,role:a})=>{await t.cancelQueries({queryKey:["admin","users"]});const m=t.getQueriesData({queryKey:["admin","users"]});return m.forEach(([y,g])=>{g&&t.setQueryData(y,{...g,users:g.users.map(E=>E.id===s?{...E,role:a}:E)})}),{previous:m}},onError:(s,a,m)=>{m?.previous.forEach(([y,g])=>{t.setQueryData(y,g)}),d.error(`Failed to update role: ${s.message}`)},onSuccess:async(s,a)=>{d.success("Role updated"),await l("role_changed",{userId:a.userId,role:a.role})},onSettled:async()=>{await t.invalidateQueries({queryKey:["admin","users"]})}}),k=I({mutationFn:async s=>be(s.id),onSuccess:async(s,a)=>{d.success(`Removed ${a.email}`),await l("user_deleted",{userId:a.id,email:a.email}),await t.invalidateQueries({queryKey:["admin","users"]}),D(null)},onError:s=>{d.error(`Failed to delete user: ${s.message}`)}}),P=N.data?.total??0,L=Math.max(1,Math.ceil(P/M)),F=i>=L-1,G=()=>{if(!_){d.error("Email is required");return}w.mutate({email:_.trim().toLowerCase(),role:T})},W=e.jsxs(h,{size:"lg",onClick:()=>r(!0),className:"inline-flex items-center gap-2",children:[e.jsx(ye,{className:"h-4 w-4"}),"Invite user"]}),J="Send an invite email to onboard a new admin or analyst.",$=o.useMemo(()=>N.data?.users??[],[N.data]);return e.jsxs(ne,{title:"Users & Roles",description:"Manage administrator and analyst access across the WinMix platform.",breadcrumbs:[{label:"Admin",href:"/admin"},{label:"Users"}],actions:W,children:[e.jsxs("section",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"relative w-full sm:max-w-xs",children:[e.jsx(xe,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(Q,{value:c,onChange:s=>{f(s.target.value),p(0)},placeholder:"Search by email",className:"h-11 pl-9"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[P," user",P===1?"":"s"]})]}),e.jsx("div",{className:"overflow-hidden rounded-lg border border-border/60",children:e.jsxs(Z,{children:[e.jsx(ee,{children:e.jsxs(b,{children:[e.jsx(S,{children:"Email"}),e.jsx(S,{children:"Role"}),e.jsx(S,{className:"hidden md:table-cell",children:"Created"}),e.jsx(S,{className:"sr-only",children:"Actions"})]})}),e.jsx(se,{children:N.isLoading?e.jsx(b,{children:e.jsx(u,{colSpan:4,className:"py-10 text-center text-muted-foreground",children:"Loading users…"})}):$.length===0?e.jsx(b,{children:e.jsx(u,{colSpan:4,className:"py-10 text-center text-muted-foreground",children:"No users found. Try adjusting your search."})}):$.map(s=>{const a=s.id===n?.id,m=s.created_at?ae(new Date(s.created_at),"PP"):"—";return e.jsxs(b,{children:[e.jsx(u,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium text-foreground",children:s.email}),s.full_name?e.jsx("span",{className:"text-xs text-muted-foreground",children:s.full_name}):null]})}),e.jsx(u,{children:e.jsxs(H,{value:s.role,onValueChange:y=>q.mutate({userId:s.id,role:y}),disabled:a||q.isPending,children:[e.jsx(K,{className:"h-11 w-[140px]",children:e.jsx(O,{})}),e.jsxs(V,{children:[e.jsx(x,{value:"admin",children:"Admin"}),e.jsx(x,{value:"analyst",children:"Analyst"}),e.jsx(x,{value:"user",children:"User"})]})]})}),e.jsx(u,{className:"hidden md:table-cell text-muted-foreground",children:m}),e.jsx(u,{className:"text-right",children:e.jsxs(h,{variant:"ghost",size:"icon",className:"h-11 w-11",disabled:a||k.isPending,onClick:()=>D(s),children:[e.jsx(he,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Delete user"})]})})]},s.id)})})]})}),e.jsxs("div",{className:"flex flex-col items-center justify-between gap-3 sm:flex-row",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Page ",i+1," of ",L]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",className:"h-11",onClick:()=>p(s=>Math.max(s-1,0)),disabled:i===0,children:"Previous"}),e.jsx(h,{variant:"outline",className:"h-11",onClick:()=>p(s=>F?s:s+1),disabled:F,children:"Next"})]})]})]}),e.jsx(re,{open:U,onOpenChange:r,children:e.jsxs(ie,{children:[e.jsxs(oe,{children:[e.jsxs(ce,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4"}),"New invitation"]}),e.jsx(de,{children:J})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",htmlFor:"invite-email",children:"Email"}),e.jsx(Q,{id:"invite-email",type:"email",value:_,onChange:s=>R(s.target.value),placeholder:"analyst@winmix.ai",autoComplete:"email",className:"h-11"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",htmlFor:"invite-role",children:"Role"}),e.jsxs(H,{value:T,onValueChange:s=>A(s),children:[e.jsx(K,{id:"invite-role",className:"h-11 w-full",children:e.jsx(O,{})}),e.jsxs(V,{children:[e.jsx(x,{value:"admin",children:"Admin"}),e.jsx(x,{value:"analyst",children:"Analyst"}),e.jsx(x,{value:"user",children:"User"})]})]})]})]}),e.jsxs(me,{className:"flex flex-col gap-2 sm:flex-row",children:[e.jsx(h,{variant:"outline",className:"h-11",onClick:()=>r(!1),disabled:w.isPending,children:"Cancel"}),e.jsx(h,{className:"h-11",onClick:G,disabled:w.isPending,children:w.isPending?"Sending…":"Send invite"})]})]})}),e.jsx(le,{open:!!j,onOpenChange:s=>{s||D(null)},title:"Remove user",description:j?e.jsxs("span",{children:["Are you sure you want to remove ",e.jsx("span",{className:"font-semibold",children:j.email}),"? This will revoke access immediately."]}):"",confirmLabel:"Remove",cancelLabel:"Cancel",destructive:!0,isConfirmLoading:k.isPending,onConfirm:()=>{j&&k.mutate(j)}})]})};export{Le as default};
